name: Qt Testing

on:
    push:
    pull_request:

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout
          uses: actions/checkout@v3

        - name: Install Qt
          uses: jurplel/install-qt-action@v3
          with:
            version: '6.4.2'
            host: 'linux'
            target: 'desktop'
            modules: 'qtimageformats qtcharts qtmultimedia'

        - name: Install deps
          run: |
            sudo apt update
            sudo apt install -y xvfb mesa-utils libgl1 libglx-mesa0

        - name: Configure
          run: cmake -S . -B build

        - name: Build
          run: cmake --build build --parallel

        - name: Run UI tests
          run: |
            cd build
            mkdir -p screenshots
            xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" \
                ctest --output-on-failure

        - name: Upload Screenshots
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: qt-screenshots
            path: build/screenshots